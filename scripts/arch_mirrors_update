#!/bin/bash

MIRRORLIST="/etc/pacman.d/mirrorlist"
MIRROR_TMP="$(mktemp)"

if [ "$(id -u )" != 0 ]; then
    echo "Must run as root"
    exit 1
fi

today="$(date +%y%m%d)"

set -x

cp "$MIRRORLIST" "$MIRRORLIST.$today"
curl "https://www.archlinux.org/mirrorlist/?country=US&protocol=https&ip_version=4&ip_version=6&use_mirror_status=on" \
    | grep -v "## United States" \
    | sed s/^#Server/Server/ \
    > "$MIRROR_TMP"

rankmirrors -n 5 "$MIRROR_TMP" >"$MIRRORLIST"
chmod 644 "$MIRRORLIST"
rm -f "$MIRROR_TMP"
